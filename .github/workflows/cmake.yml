name: GitHub Actions CI

on:
  push:
    branches: [ master ]
  pull_request:
    types: [edited, opened, reopened, synchronize]
    branches: [ master ]

env:
  VCPKG_COMMIT: 13590753fec479c5b0a3d48dd553dde8d49615fc
  VCPKG_DEST_MACOS: /Users/runner/qbt_tools/vcpkg
  VCPKG_DEST_WIN: C:\qbt_tools\vcpkg

jobs:

  ci_windows:
    name: Windows + vcpkg

    runs-on: windows-2019

    defaults:
      run:
        shell: pwsh

    steps:
    - name: checkout repository
      uses: actions/checkout@v2.3.2

    - name: install additional required packages with chocolatey
      run: |
        choco install ninja

    - name: setup vcpkg (cached, if possible)
      uses: lukka/run-vcpkg@v3.3
      with:
        vcpkgDirectory: ${{ env.VCPKG_DEST_WIN }}
        vcpkgGitCommitId: ${{ env.VCPKG_COMMIT }}
        setupOnly: true

    - name: configure vcpkg triplet overlay for release builds only
      run: |
        New-Item -Path ${{ github.workspace }} -Name "triplets_overlay" -ItemType Directory
        Copy-Item ${{ env.RUNVCPKG_VCPKG_ROOT }}/triplets/x64-windows-static.cmake `
          ${{ github.workspace }}/triplets_overlay/x64-windows-static-release.cmake
        Add-Content ${{ github.workspace }}/triplets_overlay/x64-windows-static-release.cmake `
          -Value "set(VCPKG_BUILD_TYPE release)"

    - name: install dependencies via vcpkg
      run: |
        $packages = `
          "boost-circular-buffer:x64-windows-static-release",
          "libtorrent:x64-windows-static-release",
          "qt5-base:x64-windows-static-release",
          "qt5-svg:x64-windows-static-release",
          "qt5-tools:x64-windows-static-release",
          "qt5-winextras:x64-windows-static-release"
        foreach($package in $packages)
        {
          ${{ env.RUNVCPKG_VCPKG_ROOT }}/vcpkg.exe install $package `
            --overlay-triplets=${{ github.workspace }}/triplets_overlay `
            --clean-after-build
        }

    - name: build qBittorrent
      run: |
        cmake -B build -G "Visual Studio 16 2019" `
          -DCMAKE_EXPORT_COMPILE_COMMANDS=ON -DCMAKE_BUILD_TYPE=Release `
          -DCMAKE_TOOLCHAIN_FILE=${{ env.VCPKG_DEST_WIN }}/scripts/buildsystems/vcpkg.cmake `
          -DVCPKG_TARGET_TRIPLET=x64-windows-static-release `
          -DVERBOSE_CONFIGURE=ON `
          --graphviz=build/target_graph.dot
        cmake --build build --config Release -- /p:UseMultiToolTask=true

    - name: upload artifact as zip
      uses: actions/upload-artifact@v2.1.3
      with:
        name: qBittorrent-CI-Windows_x64-static-release
        path: |
          qBittorrent\build\
